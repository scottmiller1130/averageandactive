name: Convert iPhone Images to JPEG

on:
  push:
    branches: [main]
    paths:
      - 'images/**'

  # Allow manual runs (handy for bulk re-conversion)
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install image tools
        run: sudo apt-get update && sudo apt-get install -y libheif-examples imagemagick

      - name: Detect and convert HEIF images
        run: |
          converted=false
          count=0
          for img in images/*; do
            [ -f "$img" ] || continue
            mime=$(file --mime-type -b "$img")
            case "$mime" in
              image/heif|image/heic|image/heif-sequence|image/heic-sequence)
                echo "Converting HEIF file: $img"
                base="${img%.*}"
                ext="${img##*.}"
                heif-convert "$img" "${base}_converted.jpg"
                rm "$img"
                case "$ext" in
                  jpg|jpeg|JPG|JPEG)
                    mv "${base}_converted.jpg" "${base}.${ext}"
                    ;;
                  *)
                    mv "${base}_converted.jpg" "${base}.jpg"
                    ;;
                esac
                converted=true
                count=$((count + 1))
                ;;
            esac
          done
          echo "converted=$converted" >> "$GITHUB_ENV"
          echo "count=$count" >> "$GITHUB_ENV"
          if [ "$converted" = "true" ]; then
            echo "### Converted $count image(s) from HEIF to JPEG" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### No HEIF images found â€” nothing to convert" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Commit converted images
        if: env.converted == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add images/
          git commit -m "Auto-convert ${{ env.count }} iPhone HEIF image(s) to JPEG format"
          git push
